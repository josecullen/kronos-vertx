<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
	<link rel='stylesheet' href='/bootstrap/dist/css/bootstrap.min.css'>
    <script type="text/javascript" src="/javascripts/jquery-ui-1.10.4.custom/js/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="/javascripts/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/javascripts/ol.js"></script>
    <script type="text/javascript" src="/bootstrap/dist/js/bootstrap.min.js"></script>
    <link rel='stylesheet' href='/stylesheets/style.css'>
    <link rel="stylesheet" href="/stylesheets/ol.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/samples.css">


<title>Insert title here</title>
</head>
<body>
  	<div id="map" class="map"></div>  
<!--   	<div class="btn-group" data-toggle="buttons"> -->
	  	<label class="btn btn-primary active">
	    	<input id="srcLocal" type="checkbox" onclick='changeMapSrc(this);' checked> Mapas Locales
	  	</label>
<!-- 	</div> -->
   
  <script type="text/javascript">	  
      var osmLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
      });
      var birmingham = ol.proj.transform([2.08, 48.66], 'EPSG:4326', 'EPSG:3857');      
      var view = new ol.View({      
        center: birmingham,
        zoom: 1
      });
      var map = new ol.Map({
        target: 'map',
        view: view
      });     

      var newLayer = new ol.layer.Tile({
        source: new ol.source.OSM({
          url: '/images/osm/{z}/{x}/{y}.png'
        })
      });
      
      map.addLayer(osmLayer);
      map.addLayer(newLayer);
      
      function changeMapSrc(cb){
      	if(cb.checked){
      		newLayer.setVisible(true);
      		osmLayer.setVisible(false);
      	}else{
      		newLayer.setVisible(false);
      		osmLayer.setVisible(true);
      	}
      }
      
      
      
      window.onload = function(){
        getUpdate();
      }
      
      
      var getUpdate = function(){
        $.getJSON("/getUpdate", function(data){
          console.log(data);
          if(!data.sended){
            console.log(data.update);
            if(data.update.indexOf('fly') > -1){
              console.log(data.x+" "+data.y);
              var location = ol.proj.transform([parseFloat(data.x), parseFloat(data.y)], 'EPSG:4326', 'EPSG:3857');
              doBounce(location);
            }else if(data.update.indexOf('filter') > -1){
              
              var overlays = map.getOverlays();
              console.log("overlays " +overlays.getLength());
              while(overlays.getLength() > 0){
                overlays.forEach(function(overl){
                  console.log(overl);
                  map.removeOverlay(overl);
                });    
                overlays = map.getOverlays();
              }
              
              data.acont.forEach(function(item){
                var coord = [parseFloat(item.coordenadas[0]), parseFloat(item.coordenadas[1])];
                console.log(coord);
                var div = document.createElement("div");
                var img = document.createElement("img");
                img.src = "images/icon.png";
                div.appendChild(img);
                
                var overlay = new ol.Overlay({
                  element : div,
                  positioning : 'bottom-center'
                });
                  
                var pos = ol.proj.transform(coord, 'EPSG:4326', 'EPSG:3857');
                overlay.setPosition(pos);
                map.addOverlay(overlay);
              });
            }else if(data.update.indexOf('zoom') > -1){
              var zoom = ol.animation.zoom({
                resolution: map.getView().getResolution()
              });
              map.beforeRender(zoom);
              view.setZoom(data.zoom);
            }
            
          }
        });
        setTimeout(getUpdate, 1000);
      }
      function doBounce(location) {
        // bounce by zooming out one level and back in
        var bounce = ol.animation.bounce({
          resolution: map.getView().getResolution() * 3,
          duration: 2000
        });
        // start the pan at the current center of the map
        var pan = ol.animation.pan({
          source: map.getView().getCenter()
        });
        map.beforeRender(bounce);
        map.beforeRender(pan);
        // when we set the center to the new location, the animated move will
        // trigger the bounce and pan effects
        map.getView().setCenter(location);
      }
      function doPan(location) {
        // pan from the current center
        var pan = ol.animation.pan({
          source: map.getView().getCenter()
        });
        map.beforeRender(pan);
        // when we set the new location, the map will pan smoothly to it
        map.getView().setCenter(location);
      }
     


</script>


</body>
</html>