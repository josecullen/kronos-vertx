<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel='stylesheet' href='/bootstrap/dist/css/bootstrap.min.css'>
<script type="text/javascript" src="/javascripts/jquery-ui-1.10.4.custom/js/jquery-1.10.2.js"></script>
<script type="text/javascript" src="/javascripts/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
<script type="text/javascript" src="/javascripts/ol.js"></script>
<script type="text/javascript" src="/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/javascripts/angular.min.js"></script>    

<link rel='stylesheet' href='/stylesheets/style.css'>
<link rel="stylesheet" href="/stylesheets/ol.css" type="text/css">
<link rel="stylesheet" type="text/css" href="/stylesheets/samples.css">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style type="text/css">
/* Styles go here */
.carousel {
    margin-top: 10px;
}
.item .thumb {
	width: 5%;
	cursor: pointer;
	float: left;
}
.item .thumb img {
	/*width: 100%;*/
	margin: 2px;
}




.btn-file {
  position: relative;
  overflow: hidden;
}

.btn-file input[type=file] {
  position: absolute;
  top: 0;
  right: 0;
  min-width: 100%;
  min-height: 100%;
  font-size: 100px;
  text-align: right;
  filter: alpha(opacity=0);
  opacity: 0;
  outline: none;
  background: white;
  cursor: inherit;
  display: block;
}
</style>
<title>Insert title here</title>
</head>
<body ng-app='app' ng-controller="imgController" >
<div>
	<ul class="nav nav-tabs" role="tablist">
    	<li role="presentation" class="active">
        	<a id="homa" href="#home" aria-controls="home" role="tab" data-toggle="tab">Acontecimiento</a>
      	</li>
      	<li role="presentation">
        	<a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Línea de Tiempo</a>
      	</li>
    </ul>
    <div class="tab-content">
    	<div role="tabpanel" class="tab-pane active" id="home">	
			<div class=" col-xl-6 col-lg-6 col-xs-12 col-md-6">
			<form action="/file" ENCTYPE="multipart/form-data" method="POST" class="navbar-form navbar-left">		
				
				<div class="input-group" style="width: 100%">
					<span class="input-group-addon" id="basic-addon1">Título</span> 
					<input type="text" name="titulo" ng-model="acontecimiento.titulo" class="form-control" placeholder="Batalla de San Lorenzo" aria-describedby="basic-addon1">
				</div>
				
				<div class="input-group" style="width: 100%">
					<span class="input-group-addon" id="basic-addon1">Fecha</span> 
					<input type="date" name="fecha" ng-model="acontecimiento.date" class="form-control" aria-describedby="basic-addon1">
				</div>
				
				<div class="input-group" style="width: 100%">
					<span class="input-group-addon" id="basic-addon1">Coordenadas</span>
					<input type="number" id="x" ng-model="acontecimiento.coordenadas.x" name="coordenadaX" step="0.01"	class="form-control" placeholder="37,35" aria-describedby="basic-addon1"> 
					<span class="input-group-addon" id="basic-addon1">x</span> 
					<input type="number" id="y" ng-model="acontecimiento.coordenadas.y" name="coordenadaY" step="0.01" class="form-control" placeholder="15,48" aria-describedby="basic-addon1"> 
					<span class="input-group-addon" id="basic-addon1">y</span>
				</div>

				<div class="input-group" style="width: 100%">
					<span class="input-group-addon" id="basic-addon1">Contenido</span>
						<textarea ng-model="acontecimiento.contenido" class="form-control" name="contenido" rows="2" aria-describedby="basic-addon1"></textarea>
					</div>
				
				<!-- Imagenes -->
		        <div class="row jumbotron" ng-repeat="image in acontecimiento.images">
				    <div class="col-xl-3 col-lg-3 col-xs-3 col-md-3">
				      <a href="#" class="thumbnail"  ng-if="image.imgSrc">
				        <img id="blah" class="form-control" ng-src="{{image.imgSrc}}"  >
				      </a>
				      <span class="btn btn-default btn-file">
				      Cargar Imagen <input type="file"  id="{{$index}}" name="img{{$index}}" onchange="angular.element(this).scope().fileNameChanged(this, angular.element(this))">
				      </span>
				    </div>    
					
				    <div class="col col-xl-8 col-lg-8 col-xs-8 col-md-8">
				      	<div class="input-group" style="width: 100%">
							<span class="input-group-addon" id="basic-addon1">Título Imagen</span> 
							<input type="text" name="imgTitulo{{$index}}" ng-model="image.title" class="form-control" aria-describedby="basic-addon1">
						</div>
					    <textarea class="form-control" rows="2" name="imgContenido{{$index}}" style="width: 100%" ng-model="image.content" placeholder="Contenido"></textarea>
				    </div>
				    
				    <button ng-if="$last" ng-click="newImage();" class="btn btn-primary glyphicon glyphicon-plus col-sm-1 col-xl-1 col-lg-1"></button>
				    <button ng-if="!$last" ng-click="removeItem($index);" class="btn btn-danger glyphicon glyphicon-minus col-sm-1 col-xl-1 col-lg-1"></button>
				</div>
				<!-- Imagenes -->	
				
				<!-- Íconos -->	
		        <div class="thumb" style="display: inline-block" ng-repeat="icon in acontecimiento.iconos" ng-if="icon.imgSrc">
			    	<a href="#" class="thumbnail" style="max-width: 50px">
						<img name="icon{{$index}}" src="{{icon.imgSrc}}" ng-click="setIcono(icon)">
					</a>			                    	
			    </div>      
				<!-- Íconos -->	
					
				<button type="submit" class="btn btn-default">Submit</button>
				<div id="overlay" style="background-color: white; border-radius: 10px; border: 1px solid black; padding: 5px 10px;"></div>
			</form>
			</div>
			
			
			<!-- Mapa e Íconos -->
			<div class="col-xl-6 col-lg-6 col-xs-12 col-md-6">
				<div id="map" class="map" style="height: 50%; width: 100%;"></div>
				
				<div class="row jumbotron">
					<div class="col-xs-2">
				    	<a href="#" class="thumbnail"  ng-if="icono.imgSrc">
							<img class="form-control" ng-src="{{icono.imgSrc}}">
						</a>						       		    
			   	 	</div>
			   	 	<div class="col-xs-10" >
			   	 		<div ng-if="icono.imgSrc">
			   	 		
				   	 		<div class="input-group" style="width: 100%">
								<span class="input-group-addon" id="basic-addon1">Título Ícono</span> 
								<input type="text"  ng-model="icono.title" class="form-control" aria-describedby="basic-addon1">
							</div>
							
							<div class="input-group" style="width: 100%">
								<span class="input-group-addon" >Coordenadas</span>
								<input type="number" id="iconX" ng-model="icono.coordenada.x" name="coordenadaX" step="0.01"	class="form-control" > 
								<span class="input-group-addon" >x</span> 
								
								<input type="number" id="iconY" ng-model="icono.coordenada.y" name="coordenadaY" step="0.01" class="form-control" > 
								<span class="input-group-addon" >y</span>
															
								<div class="btn-group col-xs-1" data-toggle="buttons" style="width: 100%; height: 100%">
								  	<label class="btn btn-primary active" onclick="toggleCoord = !toggleCoord">
								    	<span class="glyphicon glyphicon-asterisk"></span>
								  	</label>
								</div>														
							</div>
						
							<button class="btn btn-primary glyphicon glyphicon-plus" ng-hide="hasIcon()" ng-click="addIcon()"></button>
							<button class="btn btn-danger glyphicon glyphicon-minus" ng-show="hasIcon()" ng-click="findAndRemoveIcon()"></button>							
							<button class="btn btn-default btn-xs" ng-click="newIcon()">Nuevo</button>	
							
						</div>
						<span class="btn btn-default btn-file pull-right">
							Cargar Ícono<input type="file" onchange="angular.element(this).scope().iconoCarga(this, angular.element(this))">
						</span>	
			   	 	</div>
				</div>
			</div>
			<!-- Mapa e Íconos -->
			
			
		</div>
		
		
		<!-- TAB -->
		<div role="tabpanel" class="tab-pane" id="profile">
			<div class="col-md-5">
				<div class="input-group-btn">
					<input id="nombre-linea" name="nombreLinea" type="TextBox" ID="datebox" Class="form-control">
					<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
						<span class="caret"></span>
					</button>
					<button type="button" class="btn btn-primary">
						<span class="">Nuevo</span>
					</button>
					<ul id="listLineasDeTiempo" class="dropdown-menu"></ul>
			    </div>
		        <div id="sortable1" class="list-group connectedSortable">	
		        	<a href="#" class="list-group-item active">
		          		<h4 class="list-group-item-heading">Línea de Tiempo</h4>
	          		</a>		          	
		        </div>
	        </div>
	        <div id="sortable2" class="list-group col-md-4 connectedSortable">	
	          	<a href="#" class="list-group-item active">
	          		<h4 class="list-group-item-heading">Acontecimientos</h4>
	          	</a>
	        </div>
	        <button onclick="guardarLinea();">Guardar</button>
      	</div>
		<!-- TAB -->		
		
		<!-- Footer Íconos 	 -->
		<nav class="navbar navbar-inverse navbar-fixed-bottom">
			<div class="clearfix">
		    	<div id="thumbcarousel" class="carousel slide" data-interval="false">
		            <div class="carousel-inner">
		                <div class="item active">
		                    <div data-target="#carousel" data-slide-to="0" class="thumb"><img src="http://placehold.it/30/e8117f/fff&amp;text=Product+Main"></div>                    
		                </div>
		                <div class="item">
		                    <div data-target="#carousel" data-slide-to="8" class="thumb"><img src="http://placehold.it/30/612b65/fff&amp;text=Product+Image+5"></div>                   
		                </div><!-- /item -->
		            </div><!-- /carousel-inner -->
		            <a class="left carousel-control" href="#thumbcarousel" role="button" data-slide="prev">
		                <span class="glyphicon glyphicon-chevron-left"></span>
		            </a>
		            <a class="right carousel-control" href="#thumbcarousel" role="button" data-slide="next">
		                <span class="glyphicon glyphicon-chevron-right"></span>
		            </a>
		        </div> <!-- /thumbcarousel -->
		    </div><!-- /clearfix -->
	  	</nav>
      	<!-- Footer Íconos 	 --> 
      	
	</div>
</div>


</body>

<script type="text/javascript">
	
var app = angular.module('app', []);

app.controller('imgController',function($scope, $http){
	$scope.acontecimiento = {coordenadas: {x: '', y: ''}};	
	$scope.acontecimiento.images = [{ imgSrc: '',  content: '',  title: ''}];	
	$scope.acontecimiento.iconos = [];	  
	$scope.icono = { id: null,  imgSrc: '', title: '', coordenada: {x : '', y : ''} };
	
	$scope.update = function(){
		$scope.acontecimiento.coordenadas.x = parseFloat($('#x').val());
		$scope.acontecimiento.coordenadas.y = parseFloat($('#y').val());
	}
	
	$scope.fileNameChanged = function(input, index){
	    if (input.files && input.files[0]) {
	      var reader = new FileReader();
	      reader.onload = function(e) {
	         $scope.acontecimiento.images[index[0].id].imgSrc = e.target.result;
	         $scope.$apply();
	      }
	      reader.readAsDataURL(input.files[0]);
	    }
	};
	
	$scope.setIcono = function(icon){
		$scope.icono = icon;
	};
	
	$scope.iconoCarga = function(input, index){
	    if (input.files && input.files[0]) {
	      var reader = new FileReader();
	      reader.onload = function(e) {
	      	 console.log(input.files);
	         $scope.icono.imgSrc = e.target.result;	         
	         $scope.$apply();
	      }
	      reader.readAsDataURL(input.files[0]);
	    }
	};
	
	$scope.newImage = function() {
	    $scope.acontecimiento.images.push({
	      newImage: '',
	      content: '',
	      title: ''
		});
	};
	
	$scope.newIcon = function() {
	    $scope.icono = { id: null,  imgSrc: '', title: '', coordenada: {x : '', y : ''} };
	};
	
	$scope.removeItem = function(index) {
		$scope.acontecimiento.images.splice(index, 1);
	};
	
	$scope.findAndRemoveIcon = function(){
		var iconos = $scope.acontecimiento.iconos;
		var icono = $scope.icono;
		iconos.forEach(function(curr){
			if(	curr.id == icono.id){
				iconos.pop(curr);
			}
		});
		console.log(iconos);
	};
	
	$scope.addIcon = function(){
		console.log($scope.icono);
		if($scope.icono.id == null){
			$scope.icono.id = $scope.acontecimiento.iconos.length; 
			$scope.acontecimiento.iconos.push($scope.icono);
		}
		console.log($scope.acontecimiento);
	}
	  
	$scope.hasIcon = function(){
		var iconos = $scope.acontecimiento.iconos;
		var icono = $scope.icono;
		result = false;
		iconos.forEach(function(curr){
			if(	curr.id == icono.id){
				result = true;
				return;
			}
		});
		return result;
	};
	  
});
	

	
	
	
	$('#home a').click(function(e) {
	  e.preventDefault();
	  console.log('evento ' + e);
	  $(this).tab('show');
	});
	
	$('#demolist li').on('click', function() {
	  $('#datebox').val($(this).text());
	});
	$('#listLineasDeTiempo li').on('click', function() {
	  $('#lineas').val($(this).text());
	});
	
	$(function() {
	  $("#sortable1, #sortable2").sortable({
	    connectWith: ".connectedSortable"
	  }).disableSelection();
	});
	
	
	
	$.get("/db/findAll", function(data, status){
		//$('#sortable2').empty();	
		data.forEach(function(data){
			var item = "<a href='#' id="+data.id+" class='list-group-item'>"; 
			item += "<h4 class='list-group-item-heading'>"+data.titulo+"</h4>";
			item += "<p class='list-group-item-text'>"+data.contenido+"</p>";
			item += "</a>";
			$('#sortable2').append(item);
		});
	});	
	
	function guardarLinea(){		
		console.log($("#sortable1"));
		var acontecimientos = new Array();
		
		$("#sortable1").children('a').each(function() {
		  	$this = $(this);
		  	//console.log($this);
		  	var id = $this.attr("id");
		  	//console.log(id);
		  	if(id == null){
		  		console.log("null");
		  	}else{
		  		acontecimientos.push(id);
		  	}
		});
		console.log(JSON.stringify(acontecimientos));
		var nombreLinea = $("#nombre-linea").val();
		console.log("nombreLinea "+ nombreLinea);
		$.get("/db/saveLineaDeTiempo?titulo="+nombreLinea+"&acontecimientos="+JSON.stringify(acontecimientos), function(data, status){
		
		});	
	}
	

	var layer = new ol.layer.Tile({
		source : new ol.source.OSM()
	});

	var center = ol.proj.transform([ -60, -31 ], 'EPSG:4326', 'EPSG:3857');
	var overlay = new ol.Overlay({
		element : document.getElementById('overlay'),
		positioning : 'bottom-center'
	});

	var view = new ol.View({
		center : center,
		zoom : 6
	});

	var map = new ol.Map({
		target : 'map',
		layers : [ layer ],
		view : view
	});

	// register an event handler for the click event
	map.on('click', function(event) {
		// extract the spatial coordinate of the click event in map projection units
		var coord = event.coordinate;
		// transform it to decimal degrees
		var degrees = ol.proj.transform(coord, 'EPSG:3857', 'EPSG:4326');
		// format a human readable version
		console.log('degrees ' + degrees);
		var hdms = ol.coordinate.toStringXY(degrees, 2);
		// update the overlay element's content
		
		if(toggleCoord){
			$('#iconX').val(hdms.split(',')[0]);
			$('#iconY').val(hdms.split(',')[1].trim());		
		}else{
			$('#x').val(hdms.split(',')[0]);
			$('#y').val(hdms.split(',')[1].trim());
		}
		

		var element = overlay.getElement();
		element.innerHTML = hdms;
		// position the element (using the coordinate in the map's projection)
		overlay.setPosition(coord);
		// and add it to the map
		map.addOverlay(overlay);
	});
	
	var toggleCoord = false; //false es para el acontecimiento, true para coordenadas de ícono
	
	
</script>
</html>